# 악성 SQL 튜닝으로 초보자 탈출하기

```
show index from table; // 인덱스 정보 출력
```

SQL 튜닝 절차
1. SQL문 실행 결과와 현황 파악(결과 및 소요시간, 조인/서브쿼리 구조, 동등/범위 조건 등)
2. 가시적(테이블의 데이터건수, SELECT절 컬럼 분석, 조건절 컬럼 분석, 그루핑/정렬 컬럼), 비가시젹(실행계획, 인덱스 현황, 데이터 변경 추이, 업무적 특성)
3. 튜닝 방향 판단과 개선/적용 

## SQL 문 단순 수정으로 착한 쿼리 만들기

### 기본 키를 변형하는 나쁜 SQL 문
- 기본키 컬럼을 변형하면 인덱스를 사용하지 못함

```
// 테이블 풀 스캔(0.014s)
SELECT * 
FROM 사원
WHERE SUBSTRING(사원번호,1,4) = 1100
AND LENGTH(사원번호) = 5;

// 기본키 인덱스 활용(0.00s)
SELECT *
FROM 사원
WHERE 사원번호 BETWEEN 11000 AND 11009;
```

### 사용하지 않는 함수를 포함하는 나쁜 SQL 문
- NOT NULL 속성의 키에 IFNULL 함수를 사용

```
// Using temporary(0.241s)
SELECT IFNULL(성별, 'NO DATA') AS 성별, COUNT(1) 건수
FROM 사원
GROUP BY IFNULL(성별, 'NO DATA');

// Using index(0.093s)
SELECT 성별, COUNT(1) 건수
FROM 사원
GROUP BY 성별;
```

### 형변환으로 인덱스를 활용하지 못하는 나쁜 SQL 문
- char(1) 타입을 int타입으로 넣어 묵시적 형변환이 일어나는 경우
- 데이터 유형에 맞게 열을 활용해야 내부적인 형변환이 발생되지 않으며 형변환의 영향으로 의도한 인덱스를 제대로 사용하지 못하는 경우가 있음

```
// 사용여부 인덱스를 제대로 활용하지 못해 많은 데이터를 가져옴(0.510s)
SELECT COUNT(1)
FROM 급여
WHERE 사용여부 = 1;

// 사용여부 인덱스 제대로 활용하여 적은 데이터를 가져옴(0.020s)
SELECT COUNT(1)
FROM 급여
WHERE 사용여부 = '1';
```

### 열을 결합하여 사용하는 나쁜 SQL 문

```
// 테이블 풀 스캔, 30만건 데이터 조회(0.25s)
SELECT *
FROM 사원
WHERE CONCAT(성별, ' ', 성) = 'M Radwan';

// 성별_성 인덱스를 사용하여 102건 데이터 조회(0.01s)
SELECT *
FROM 사원
WHERE 성별 = 'M'
AND 성 = 'Radwan';
```

### 습관적으로 중복을 제거하는 나쁜 SQL 문
- DISTINCT 키워드는 나열된 열들을 정렬한 뒤 중복된 데이터를 삭제함(정렬이 포함됨)
- 소요시간의 차이는 크게 나지 않지만 임시 테이블에서 정렬과 중복 제거하는 작업이 제거되었음

```
// 사원.사원번호(PK)는 중복된 데이터가 없음, Using temporary(0.001s)
SELECT DISTINCT 사원.사원번호, 사원.이름, 사원.성, 부서관리자.부서번호 
FROM 사원
JOIN 부서관리자
ON 사원.사원번호 = 부서관리자.사원번호;

// 이미 PK이므로 DISTINCT를 사용할 필요가 없음, Using index(0.001s)
SELECT 사원.사원번호, 사원.이름, 사원.성, 부서관리자.부서번호 
FROM 사원
JOIN 부서관리자
ON 사원.사원번호 = 부서관리자.사원번호;
```

### 다수 쿼리를 UNION 연산자로만 합치는 나쁜 SQL 문
- UNION ALL: 여러 개의 SELECT 문을 실행한 결과를 단순히 합치는 것
- UNION: 여러 개의 SELECT 문 실행 결과를 합친 뒤 중복된 데이터를 제거함

```
// 정렬하여 중복 제거, Using temporary(0.01s)
SELECT 'M' AS 성별, 사원번호
FROM 사원
WHERE 성별 = 'M'
AND 성 ='Baba'

UNION

SELECT 'F', 사원번호
FROM 사원
WHERE 성별 = 'F'
AND 성 = 'Baba';

// 정렬하여 중복 제거하는 부분이 필요없으므로 임시 테이블을 만들지 않음(0.01s)
SELECT 'M' AS 성별, 사원번호
FROM 사원
WHERE 성별 = 'M'
AND 성 ='Baba'

UNION ALL

SELECT 'F' AS 성별, 사원번호
FROM 사원
WHERE 성별 = 'F'
AND 성 = 'Baba';
```